# REST API

## Общие положения

Как и в остальной части приложения основные задачи - минимализация дублирования кода и обеспечение максимальной
универсальности. Поэтому API построено на общих методах, которые позволяют работать с любыми сущностями системы.

## Контроллеры

Все контроллеры наследуются от базового контроллера `BaseRestController`, который 
- реализует общие методы CRUD операций
- реализует общие методы поиска и фильтрации search и filter
- Содержит аннотации контроллера и методов для генерации OpenAPI спецификации ([Swagger](swagger/readme.md))

## Поиск и фильтрация

Основная идея - реализовать универсальный механизм поиска и фильтрации, который будет использовать уже объявленные в 
моделях атрибуты (и их метаданные) для поиска.
Упрощенно алгоритм реализации поиска выглядит так:
- В модели объявлены атрибуты, у которых указаны метаданные:
  - join - список связанных моделей, которые необходимо присоединить для поиска по этому атрибуту 
  (если не указан, значит поиск по основной таблице модели). 
  - filter - SQL выражение для этого атрибута 
  (если не указано, значит имя атрибута соответствует имени в основной таблице модели)  
  Например, для возможности поиска расписаний предоставляющих определенный тип доступа (например VPN) нужно указывать: 
  ```php
  'accessTypes' => [
    'Тип доступа', //для ACLs
    'indexHint' => 'Все типы доступа к ресурсам, которые присутствуют в этом временном доступе'.
    static::searchableOrHint,
    'join'=>['acls.aces.accessTypes'], // присоединяем связанные модели ACLs -> Aces -> AccessTypes
    'filter'=>'access_types.name',  // SQL выражение этого атрибута, для формирования поискового запроса
    ],
  ```
- В контроллере перечисляются атрибуты, по которым разрешен поиск ```static::$searchFields```
  - Можно указывать другие имена атрибутов, которые будут использоваться в API для поиска:
  ```php
  public static $searchFields=[
    'id',
    'accessTypeName'=>'access_types.name', // разрешаем поиск атрибуту accessTypeName хотя в модели такого атрибута нет
  ];
  ```
- В контроллере перечисляются параметры по которым ведется не точный поиск (LIKE) ```static::$likeSearchFields```.
Поскольку в предыдущем массиве можно объявлять разные поисковые параметры, которые мапятся в один и тот же атрибут модели,
то можно объявлять для одного атрибута параметры для строго и не строго поиска:
  ```php
  public static $searchFields=[
    'id',
    'name',              // точный поиск
    'name-like'=>'name', // неточный поиск
  ];
  
  public static $likeSearchFields=[
    'name-like', //разрешаем не точный поиск по этому параметру
  ];
  ```
- В контроллере объявляется по каким полям сортировать результаты по умолчанию. Пример:
  ```php
  public static $searchOrder=[
    'Uvolen'=>SORT_ASC,
    'Persg'=>SORT_ASC,
  ];
  ```
- Если в дочернем контроллере переписать методы search и filter и не переопределять аннотацию этих методов, 
то можно по прежнему использовать ```static::$searchFields``` для использования в аннотации методов search и filter
для перечисления параметров.
  
  